/* ========================================================================== */
/*	Exp21_2.c : D/A Converter Triangular Wave Output using Interrupt      */
/* ========================================================================== */
/*			  Designed and programmed by Duck-Yong Yoon in 2010.  */

#include <avr/io.h>
#include <avr/interrupt.h>
#include "OK-128LCD.h"

unsigned char i;
unsigned char tri_table[100] = {		// triangular wave data table
    0x00,0x05,0x0A,0x0F,0x14,0x1A,0x1F,0x24,0x29,0x2E,
    0x33,0x38,0x3D,0x42,0x47,0x4D,0x52,0x57,0x5C,0x61,
    0x66,0x6B,0x70,0x75,0x7A,0x80,0x85,0x8A,0x8F,0x94,
    0x99,0x9E,0xA3,0xA8,0xAD,0xB3,0xB8,0xBD,0xC2,0xC7,
    0xCC,0xD1,0xD6,0xDB,0xE0,0xE6,0xEB,0xF0,0xF5,0xFA,
    0xFF,0xFA,0xF5,0xF0,0xEB,0xE5,0xE0,0xDB,0xD6,0xD1,
    0xCC,0xC7,0xC2,0xBD,0xB8,0xB2,0xAD,0xA8,0xA3,0x9E,
    0x99,0x94,0x8F,0x8A,0x85,0x7F,0x7A,0x75,0x70,0x6B,
    0x66,0x61,0x5C,0x57,0x52,0x4C,0x47,0x42,0x3D,0x38,
    0x33,0x2E,0x29,0x24,0x1F,0x19,0x14,0x0F,0x0A,0x05 };

ISR(TIMER1_COMPA_vect)				/* OC1A interrupt function */
{
  PORTA = tri_table[i];				// output data to D/A
  i++;
  if(i == 100)
    i = 0;
}

int main(void)
{
  MCU_initialize();                             // initialize MCU and kit
  Delay_ms(50);                                 // wait for system stabilization
  LCD_initialize();                             // initialize text LCD module
  Beep();

  LCD_string(0x80," DAC0800 by Int.");          // display title
  LCD_string(0xC0,"Triangular Wave ");

  TCCR1A = 0x00;                                // CTC mode(4), don't output OC1A
  TCCR1B = 0x0A;                                // 16MHz/8/(1+19) = 100kHz
  TCCR1C = 0x00;
  OCR1A = 19;
  TCNT1 = 0x0000;                               // clear Timer/Counter1

  TIFR = 0x10;                                  // clear OC1A interrupt flag
  TIMSK = 0x10;                                 // enable OC1A interrupt
  sei();                                        // global interrupt enable

  i = 0;

  while(1);                                     // wait interrupt
}

